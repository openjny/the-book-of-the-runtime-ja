# ReadyToRun æ¦‚è¦

::: info åŸæ–‡
ã“ã®ç« ã®åŸæ–‡ã¯ [ReadyToRun Overview](https://github.com/dotnet/runtime/blob/main/docs/design/coreclr/botr/readytorun-overview.md) ã§ã™ã€‚
:::

## å‹•æ©Ÿ

.NET ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒç™»å ´ã—ã¦ã‹ã‚‰ã€ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®é…å¸ƒã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã«ä½¿ç”¨ã§ãã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã¯ CLI ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã®1ã¤ã ã‘ã§ã—ãŸã€‚ã“ã®å½¢å¼ã§ã¯ã™ã¹ã¦ã®å®Ÿè¡ŒãŒãƒã‚·ãƒ³éä¾å­˜ã®ä¸­é–“è¨€èª (IL) ã¨ã—ã¦è¡¨ç¾ã•ã‚Œã€ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œå‰ã«ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

::: tip ğŸ’¡ åˆå¿ƒè€…å‘ã‘è£œè¶³
é€šå¸¸ã€C# ã®ã‚³ãƒ¼ãƒ‰ã¯ ILï¼ˆä¸­é–“è¨€èªï¼‰ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã€å®Ÿè¡Œæ™‚ã« JIT ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã—ã¾ã™ã€‚ã“ã‚Œã«ã¯èµ·å‹•æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚ReadyToRun ã¯ã€ã‚ã‚‰ã‹ã˜ã‚ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã€èµ·å‹•ã‚’é«˜é€ŸåŒ–ã™ã‚‹æŠ€è¡“ã§ã™ã€‚`dotnet publish` ã§ `-p:PublishReadyToRun=true` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã¨åˆ©ç”¨ã§ãã¾ã™ã€‚
:::

åŠ¹ç‡çš„ã§ç›´æ¥å®Ÿè¡Œå¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒãªã„ã“ã¨ã¯ã€ã‚¢ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚³ãƒ¼ãƒ‰ã¨æ¯”è¼ƒã—ã¦å¤§ããªå•é¡Œã¨ãªã£ã¦ãã¾ã—ãŸï¼š

- ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«ã¯æ¯”è¼ƒçš„é•·ã„æ™‚é–“ãŒã‹ã‹ã‚Šã€é›»åŠ›ã‚’æ¶ˆè²»ã™ã‚‹
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£/æ”¹ã–ã‚“é˜²æ­¢ã®ãŸã‚ã«ã€å®Ÿè¡Œã•ã‚Œã‚‹ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã‚’æ¤œè¨¼ã™ã‚‹å¼·ã„è¦æœ›ãŒã‚ã‚‹
- æ—¢å­˜ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ç”Ÿæˆæˆ¦ç•¥ã¯è„†å¼±ãªã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒæ›´æ–°ã•ã‚Œã‚‹ã¨ã™ã¹ã¦ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹

## å•é¡Œã®åˆ¶ç´„

.NET ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«ã¯ä»¥å‰ã‹ã‚‰ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ (NGEN) ãŒã‚ã‚Šã¾ã—ãŸãŒã€ã“ã“ã§ææ¡ˆã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¯ NGEN ã¨ã¯ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£çš„ã«ç•°ãªã‚Šã¾ã™ã€‚NGEN ã¯åŸºæœ¬çš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚ã‚Šã€ã‚¢ãƒ—ãƒªã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«ã®ã¿å½±éŸ¿ï¼‰ã§ã‚ã‚‹ãŸã‚ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã®è„†å¼±æ€§ã¯å•é¡Œã«ãªã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

**ReadyToRun ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã¯ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®æ›´æ–°ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšãƒ•ã‚¡ã‚¤ãƒ«ãŒå‹•ä½œã—ç¶šã‘ã‚‹ã¨ã„ã†å¼·ã„ä¿è¨¼ã‚’æä¾›ã—ã¾ã™ã€‚**

::: tip ğŸ’¡ åˆå¿ƒè€…å‘ã‘è£œè¶³
NGENï¼ˆä»¥å‰ã® AOT æŠ€è¡“ï¼‰ã§ã¯ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒæ›´æ–°ã•ã‚Œã‚‹ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒç„¡åŠ¹ã«ãªã‚Šã€å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒå¿…è¦ã§ã—ãŸã€‚ReadyToRun ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³è€æ€§ã‚’æŒã¤ã‚ˆã†è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒæ›´æ–°ã•ã‚Œã¦ã‚‚ä»¥å‰ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿ã‚³ãƒ¼ãƒ‰ãŒå¼•ãç¶šãå‹•ä½œã—ã¾ã™ã€‚
:::

## ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¦‚è¦

CLI ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’å‡ºç™ºç‚¹ã¨ã—ã¦ã€ä»¥ä¸‹ã®æ–¹æ³•ã§æ‹¡å¼µã—ã¾ã™ï¼š

1. æ—¢å­˜ã® CLI å½¢å¼ã«ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã—ã€ç›´æ¥å®Ÿè¡Œã«å¿…è¦ãªè¿½åŠ æƒ…å ±ã‚’å«ã‚ã‚‹
2. ã™ã¹ã¦ã®æ©Ÿèƒ½ã‚’å³åº§ã«ã‚µãƒãƒ¼ãƒˆï¼ˆå®Œå…¨ãª CLI ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆï¼‰
3. æœ€ã‚‚é‡è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’è¿½åŠ ã—ã€ãã‚Œä»¥å¤–ã¯ CLI å½¢å¼ã®å‡¦ç†ãƒ‘ã‚¹ã‚’ä½¿ç”¨

è¿½åŠ æƒ…å ±ã®æœ€ã‚‚é‡è¦ãªéƒ¨åˆ†ï¼š

- **ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰**: ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã¨å¤–éƒ¨å‚ç…§æ–¹æ³•
- **GC æƒ…å ±**: å„ãƒ¡ã‚½ãƒƒãƒ‰ã® GC ãƒã‚¤ãƒ³ã‚¿æƒ…å ±
- **ä¾‹å¤–å‡¦ç†ãƒ†ãƒ¼ãƒ–ãƒ«**: ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®æ¤œç´¢ç”¨
- **IP ãƒãƒƒãƒ—**: å‘½ä»¤ãƒã‚¤ãƒ³ã‚¿ã‹ã‚‰ GC/EH æƒ…å ±ã¸ã®å¯¾å¿œãƒ†ãƒ¼ãƒ–ãƒ«
- **ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒªãƒ³ã‚¯ãƒ†ãƒ¼ãƒ–ãƒ«**: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ãƒã‚¤ãƒ†ã‚£ãƒ–æ§‹é€ ã‚’çµã³ã¤ã‘ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³äº’æ›æ€§ã®å®šç¾©

CIL ã¨åŒã˜äº’æ›æ€§ãƒ«ãƒ¼ãƒ«ã‚’æŒã¤ã“ã¨ãŒç†æƒ³ã§ã™ãŒã€ã™ã¹ã¦ã®ã‚±ãƒ¼ã‚¹ã§åŠ¹ç‡çš„ã«è¡Œã†ã“ã¨ã¯å›°é›£ã§ã™ã€‚æœ€ã‚‚é›£ã—ã„å•é¡Œã¯å€¤å‹ï¼ˆæ§‹é€ ä½“ï¼‰ã¨ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã«é–¢ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

**å€¤å‹ã®äº’æ›æ€§ãƒ«ãƒ¼ãƒ«**: å…¬é–‹å€¤å‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚’å«ã‚€ï¼‰ã®æ•°ã‚„å‹ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ç ´å£Šçš„å¤‰æ›´ã§ã™ã€‚ãŸã ã—ã€éå…¬é–‹ï¼ˆinternalï¼‰ã®æ§‹é€ ä½“ã§ã€å…¬é–‹å€¤å‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚¹ãƒˆã‹ã‚‰åˆ°é”ã§ããªã„å ´åˆã¯ã“ã®åˆ¶é™ã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚

ä»¥ä¸‹ã®å¤‰æ›´ã¯è¨±å¯ã•ã‚Œã¾ã™ï¼š

1. å‚ç…§ã‚¯ãƒ©ã‚¹ã¸ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨é™çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ 
2. å€¤ã‚¯ãƒ©ã‚¹ã¸ã®é™çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ 
3. ä»®æƒ³ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿½åŠ 
4. æ—¢å­˜ãƒ¡ã‚½ãƒƒãƒ‰ã®å¤‰æ›´ï¼ˆã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ãŒäº’æ›ã§ã‚ã‚‹å ´åˆï¼‰
5. æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã®è¿½åŠ 

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒ–ãƒ«

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒ–ãƒ«**ã¨ã¯ã€ã‚»ãƒƒãƒˆã¨ã—ã¦æ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’å‰æã¨ã—ãŸ DLL ã®ã‚»ãƒƒãƒˆã§ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã®è¦³ç‚¹ã‹ã‚‰ã¯ã€ã“ã® DLL ã®ã‚»ãƒƒãƒˆã¯å˜ä¸€ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒ–ãƒ«å†…ã§ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã‚„ãã®ä»–ã®ã‚¯ãƒ­ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æœ€é©åŒ–ãŒè¨±å¯ã•ã‚Œã¾ã™ã€‚

::: tip ğŸ’¡ åˆå¿ƒè€…å‘ã‘è£œè¶³
ä¾‹ãˆã°ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã® DLL A ã¨ DLL B ãŒå¸¸ã«ã‚»ãƒƒãƒˆã§é…å¸ƒã•ã‚Œã‚‹å ´åˆã€ãã‚Œã‚‰ã‚’ã€Œãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒ–ãƒ«ã€ã¨ã—ã¦å®šç¾©ã§ãã¾ã™ã€‚ãƒãƒ–ãƒ«å†…ã§ã¯ã€DLL A ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ DLL B ã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã™ã‚‹ãªã©ã®æœ€é©åŒ–ãŒå¯èƒ½ã§ã™ã€‚ä¸€æ–¹ã€ãƒãƒ–ãƒ«ã®å¢ƒç•Œã‚’è¶Šãˆã‚‹å ´åˆã¯ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³è€æ€§ã®ãŸã‚ã«ã“ã®ã‚ˆã†ãªæœ€é©åŒ–ã¯åˆ¶é™ã•ã‚Œã¾ã™ã€‚
:::

**é‡è¦ãªåŸå‰‡**: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒ–ãƒ«ã‚’ã¾ãŸãŒãªã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚„å‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’å—ã‘ã¾ã›ã‚“ã€‚

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³è€æ€§ã®ã‚ã‚‹ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

### ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹

ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒ–ãƒ«å†…ã®å ´åˆã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚ªãƒ•ã‚»ãƒƒãƒˆã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æ—¢çŸ¥ã®å®šæ•°ã¨ã—ã¦ã‚³ãƒ¼ãƒ‰ã«åŸ‹ã‚è¾¼ã‚ã¾ã™ï¼š

```
MOV RAX, [RCX + iField_Offset]
```

ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒ–ãƒ«ã‚’ã¾ãŸãå ´åˆã€åŸºåº•ã‚¯ãƒ©ã‚¹ã®ã‚µã‚¤ã‚ºãŒå¤‰æ›´ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€å‹•çš„ãªå€¤ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

```
MOV TMP, [SIZE_OF_BASECLASS]
MOV EAX, [RCX + TMP + subfield_OffsetInSubClass]
```

### JIT ã®é¸æŠçš„ä½¿ç”¨

ãƒãƒ¼ã‚¸ãƒ§ãƒ³è€æ€§ã«é–¢é€£ã™ã‚‹ã‚³ãƒ¼ãƒ‰å“è³ªã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã€JIT ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®é¸æŠçš„ä½¿ç”¨ã‚‚å¯èƒ½ã§ã™ã€‚ä¾‹ãˆã°ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒ–ãƒ«ã‚’ã¾ãŸãã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–å€™è£œãŒã‚ã‚‹å ´åˆã€è©²å½“ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¯¾è±¡ã¨ã—ã¦å±æ€§ã§æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€JIT ãŒè‡ªç”±ã«æœ€é©åŒ–ã‚’é©ç”¨ã§ãã¾ã™ã€‚

::: tip ğŸ’¡ åˆå¿ƒè€…å‘ã‘è£œè¶³
ReadyToRun ã¯ã€Œäº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã€ã¨ã€ŒJIT ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã€ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã»ã¨ã‚“ã©ã®ã‚³ãƒ¼ãƒ‰ã¯äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¾ã™ãŒã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒé‡è¦ãªä¸€éƒ¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ JIT ã«ä»»ã›ã‚‹ã“ã¨ã§ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³è€æ€§ã¨æœ€é«˜ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ä¸¡æ–¹ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚
:::

> ğŸ“– ã“ã®ç« ã¯ã¾ã ç¿»è¨³é€”ä¸­ã§ã™ã€‚[ç¿»è¨³ã«è²¢çŒ®ã™ã‚‹](https://github.com/openjny/the-book-of-the-runtime-ja)
